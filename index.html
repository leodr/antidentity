<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Anonymous Credentials Generator</title>

    <!-- CSS Reset -->
    <style>
      /*
! tailwindcss v3.0.23 | MIT License | https://tailwindcss.com
*/

      /*
1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)
2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)
*/

      *,
      ::before,
      ::after {
        box-sizing: border-box;
        /* 1 */
        border-width: 0;
        /* 2 */
        border-style: solid;
        /* 2 */
        border-color: #e5e7eb;
        /* 2 */
      }

      /*
1. Use a consistent sensible line-height in all browsers.
2. Prevent adjustments of font size after orientation changes in iOS.
3. Use a more readable tab size.
4. Use the user's configured `sans` font-family by default.
*/

      html {
        line-height: 1.5;
        /* 1 */
        -webkit-text-size-adjust: 100%;
        /* 2 */
        -moz-tab-size: 4;
        /* 3 */
        tab-size: 4;
        /* 3 */
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        /* 4 */
      }

      /*
1. Remove the margin in all browsers.
2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.
*/

      body {
        margin: 0;
        /* 1 */
        line-height: inherit;
        /* 2 */
      }

      /*
1. Add the correct height in Firefox.
2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)
3. Ensure horizontal rules are visible by default.
*/

      hr {
        height: 0;
        /* 1 */
        color: inherit;
        /* 2 */
        border-top-width: 1px;
        /* 3 */
      }

      /*
Add the correct text decoration in Chrome, Edge, and Safari.
*/

      abbr:where([title]) {
        -webkit-text-decoration: underline dotted;
        text-decoration: underline dotted;
      }

      /*
Remove the default font size and weight for headings.
*/

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-size: inherit;
        font-weight: inherit;
      }

      /*
Reset links to optimize for opt-in styling instead of opt-out.
*/

      a {
        color: inherit;
        text-decoration: inherit;
      }

      /*
Add the correct font weight in Edge and Safari.
*/

      b,
      strong {
        font-weight: bolder;
      }

      /*
1. Use the user's configured `mono` font family by default.
2. Correct the odd `em` font sizing in all browsers.
*/

      code,
      kbd,
      samp,
      pre {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        /* 1 */
        font-size: 1em;
        /* 2 */
      }

      /*
Add the correct font size in all browsers.
*/

      small {
        font-size: 80%;
      }

      /*
Prevent `sub` and `sup` elements from affecting the line height in all browsers.
*/

      sub,
      sup {
        font-size: 75%;
        line-height: 0;
        position: relative;
        vertical-align: baseline;
      }

      sub {
        bottom: -0.25em;
      }

      sup {
        top: -0.5em;
      }

      /*
1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)
2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)
3. Remove gaps between table borders by default.
*/

      table {
        text-indent: 0;
        /* 1 */
        border-color: inherit;
        /* 2 */
        border-collapse: collapse;
        /* 3 */
      }

      /*
1. Change the font styles in all browsers.
2. Remove the margin in Firefox and Safari.
3. Remove default padding in all browsers.
*/

      button,
      input,
      optgroup,
      select,
      textarea {
        font-family: inherit;
        /* 1 */
        font-size: 100%;
        /* 1 */
        line-height: inherit;
        /* 1 */
        color: inherit;
        /* 1 */
        margin: 0;
        /* 2 */
        padding: 0;
        /* 3 */
      }

      /*
Remove the inheritance of text transform in Edge and Firefox.
*/

      button,
      select {
        text-transform: none;
      }

      /*
1. Correct the inability to style clickable types in iOS and Safari.
2. Remove default button styles.
*/

      button,
      [type="button"],
      [type="reset"],
      [type="submit"] {
        -webkit-appearance: button;
        /* 1 */
        background-color: transparent;
        /* 2 */
        background-image: none;
        /* 2 */
      }

      /*
Use the modern Firefox focus style for all focusable elements.
*/

      :-moz-focusring {
        outline: auto;
      }

      /*
Remove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)
*/

      :-moz-ui-invalid {
        box-shadow: none;
      }

      /*
Add the correct vertical alignment in Chrome and Firefox.
*/

      progress {
        vertical-align: baseline;
      }

      /*
Correct the cursor style of increment and decrement buttons in Safari.
*/

      ::-webkit-inner-spin-button,
      ::-webkit-outer-spin-button {
        height: auto;
      }

      /*
1. Correct the odd appearance in Chrome and Safari.
2. Correct the outline style in Safari.
*/

      [type="search"] {
        -webkit-appearance: textfield;
        /* 1 */
        outline-offset: -2px;
        /* 2 */
      }

      /*
Remove the inner padding in Chrome and Safari on macOS.
*/

      ::-webkit-search-decoration {
        -webkit-appearance: none;
      }

      /*
1. Correct the inability to style clickable types in iOS and Safari.
2. Change font properties to `inherit` in Safari.
*/

      ::-webkit-file-upload-button {
        -webkit-appearance: button;
        /* 1 */
        font: inherit;
        /* 2 */
      }

      /*
Add the correct display in Chrome and Safari.
*/

      summary {
        display: list-item;
      }

      /*
Removes the default spacing and border for appropriate elements.
*/

      blockquote,
      dl,
      dd,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      hr,
      figure,
      p,
      pre {
        margin: 0;
      }

      fieldset {
        margin: 0;
        padding: 0;
      }

      legend {
        padding: 0;
      }

      ol,
      ul,
      menu {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      /*
Prevent resizing textareas horizontally by default.
*/

      textarea {
        resize: vertical;
      }

      /*
1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)
2. Set the default placeholder color to the user's configured gray 400 color.
*/

      input::placeholder,
      textarea::placeholder {
        opacity: 1;
        /* 1 */
        color: #9ca3af;
        /* 2 */
      }

      /*
Set the default cursor for buttons.
*/

      button,
      [role="button"] {
        cursor: pointer;
      }

      /*
Make sure disabled buttons don't get the pointer cursor.
*/

      :disabled {
        cursor: default;
      }

      /*
1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)
2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)
   This can trigger a poorly considered lint error in some tools but is included by design.
*/

      img,
      svg,
      video,
      canvas,
      audio,
      iframe,
      embed,
      object {
        display: block;
        /* 1 */
        vertical-align: middle;
        /* 2 */
      }

      /*
Constrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)
*/

      img,
      video {
        max-width: 100%;
        height: auto;
      }

      /*
Ensure the default browser behavior of the `hidden` attribute.
*/

      [hidden] {
        display: none;
      }
    </style>

    <!-- Main stylesheet -->
    <style>
      html,
      body {
        min-height: 100%;
        color: #ec6043;
      }

      html {
        background-color: #33171c;
        background-image: radial-gradient(
          farthest-corner at top center,
          #33171c 40%,
          #090815 100%
        );
      }

      .pattern {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23090815' fill-opacity='1' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .bevel {
        --bevel-size: 12px;

        clip-path: polygon(
          0% 0%,
          100% 0%,
          100% calc(100% - var(--bevel-size)),
          calc(100% - var(--bevel-size)) 100%,
          0% 100%
        );
        padding: 1px;
      }

      .bevel-inner {
        clip-path: polygon(
          0% 0%,
          100% 0%,
          100% calc(100% - var(--bevel-size)),
          calc(100% - var(--bevel-size)) 100%,
          0% 100%
        );
      }
    </style>
  </head>
  <body>
    <div
      class="pattern"
      style="
        opacity: 12%;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      "
    ></div>
    <main
      style="
        max-width: 500px;
        margin: 0 auto;
        padding: 40px 16px;
        position: relative;
      "
    >
      <div style="display: flex; align-items: center; flex-direction: column">
        <div>
          <h1
            style="
              font-size: 1rem;
              font-weight: bold;
              line-height: 1;
              color: #f35f54;
              padding: 0 12px;
              text-transform: uppercase;
              margin-bottom: 12px;
            "
          >
            antidentity
          </h1>
          <div style="height: 2px; background-color: #f35f54"></div>
        </div>
      </div>
      <div style="margin-top: 20px">
        <label for="salt-input">salt</label>
        <div class="bevel" style="background-color: #cb524a">
          <textarea
            class="bevel-inner"
            style="
              display: block;
              width: 100%;
              padding: 10px 12px;
              background-color: #17121f;
              color: #89f2fb;
              resize: none;
              overflow-y: hidden;
            "
            name="salt"
            id="salt-input"
            placeholder='e.g. "Socks and sandals are my absolute favorite headwear."'
          ></textarea>
        </div>
      </div>

      <div
        style="background-color: #89f2fb; height: 1px; margin: 32px 0 20px"
      ></div>

      <div>
        <label for="domain-input">
          domain
          <div class="bevel" style="background-color: #cb524a">
            <input
              class="bevel-inner"
              style="
                width: 100%;
                padding: 10px 12px;
                background-color: #17121f;
                color: #89f2fb;
              "
              type="url"
              name="domain"
              id="domain-input"
              placeholder='e.g. "reddit.com"'
            />
          </div>
        </label>
      </div>

      <div style="margin-top: 32px">
        <h2>username</h2>
        <div class="bevel" style="background-color: #f6837a">
          <button
            class="bevel-inner"
            style="
              background-color: #e1574d;
              color: #17121f;
              width: 100%;
              padding: 8px;
            "
            id="username-button"
          ></button>
        </div>
      </div>
      <div style="margin-top: 8px">
        <h2>password</h2>
        <div class="bevel" style="background-color: #f6837a">
          <button
            class="bevel-inner"
            style="
              background-color: #e1574d;
              color: #17121f;
              width: 100%;
              padding: 8px;
            "
            id="password-button"
          ></button>
        </div>
      </div>
    </main>

    <script>
      const localStorageSaltKey = "salt-storage";

      /*
       * These characters are honestly picked pretty arbitrarily.
       *
       * Vocals are removed so words don't accidentally come up in the username.
       * l is removed because it sometimes can't properly be distinguished. j
       * and k are removed because I don't like them and w and m are removed
       * because they are the most dense characters and hurt my eyes the most.
       */
      const hexMap = new Map([
        ["0", "b"],
        ["1", "c"],
        ["2", "d"],
        ["3", "f"],
        ["4", "g"],
        ["5", "h"],
        ["6", "n"],
        ["7", "p"],
        ["8", "q"],
        ["9", "r"],
        ["a", "s"],
        ["b", "t"],
        ["c", "v"],
        ["d", "x"],
        ["e", "y"],
        ["f", "z"],
      ]);

      const saltInput = document.querySelector("#salt-input");
      const domainInput = document.querySelector("#domain-input");

      const usernameButton = document.querySelector("#username-button");
      const passwordButton = document.querySelector("#password-button");

      initialize();

      async function initialize() {
        saltInput.value = localStorage.getItem(localStorageSaltKey) || "";

        saltInput.addEventListener("input", (event) => {
          localStorage.setItem(localStorageSaltKey, event.target.value);

          updateCredentials();
        });

        saltInput.style.height = saltInput.scrollHeight + "px";
        saltInput.addEventListener(
          "input",
          (event) => {
            saltInput.style.height = "auto";
            saltInput.style.height = saltInput.scrollHeight + "px";
          },
          false
        );

        domainInput.addEventListener("input", () => {
          updateCredentials();
        });

        usernameButton.addEventListener("click", (event) => {
          const text = event.target.textContent;

          navigator.clipboard.writeText(text);
        });
        passwordButton.addEventListener("click", (event) => {
          const text = event.target.textContent;

          navigator.clipboard.writeText(text);
        });

        await updateCredentials();
      }

      async function updateCredentials() {
        const salt = saltInput.value;
        const domain = domainInput.value;

        const usernameBaseText = "username" + domain + salt;
        const passwordBaseText = "password" + domain + salt;

        const [newUsername, newPassword] = await Promise.all([
          getHexHash(usernameBaseText, 10),
          getBase64Hash(passwordBaseText, 24),
        ]);

        // Replace the hex encoding of the username with regular characters
        // because some sites won't allow numbers in usernames or usernames
        // starting with numbers.
        const newMappedUsername = newUsername
          .split("")
          .map((c) => hexMap.get(c))
          .join("");

        // Add some special symbols because they are required for some sites.
        const newModifiedPassword =
          newPassword.slice(0, 4) +
          "!" +
          newPassword.slice(5, 16) +
          "=" +
          newPassword.slice(17, 24);

        usernameButton.textContent = newMappedUsername;
        passwordButton.textContent = newModifiedPassword;
      }

      /**
       * Code based on MDN example:
       * https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest#converting_a_digest_to_a_hex_string
       */
      async function getHash(text) {
        const msgUint8 = new TextEncoder().encode(text);

        const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
        const hashArray = new Uint8Array(hashBuffer);

        return hashArray;
      }

      async function getHexHash(text, length) {
        const hashArray = await getHash(text);

        const hashHex = Array.from(hashArray)
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");

        if (typeof length === "number") {
          return hashHex.slice(0, length);
        }

        return hashHex;
      }

      async function getBase64Hash(text, length) {
        const hashArray = await getHash(text);

        const base64Hash = uint8ToBase64(hashArray);

        if (typeof length === "number") {
          return base64Hash.slice(0, length);
        }

        return base64Hash;
      }

      /**
       * Based on https://stackoverflow.com/a/9458996
       */
      function uint8ToBase64(bytes) {
        let binary = "";
        let len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }
    </script>
  </body>
</html>
